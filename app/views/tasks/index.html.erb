<%= render partial: "plants/sidebar" %>
<%= render partial: "plants/header" %>

<% if @plant.tasks.empty? %>
  Es sind noch keine Aufgaben angelegt worden.
  <h3>Neue Aufgabe</h3>
  <%= render partial: "form" %>

<% else %>
  <h3>Aufgaben</h3>
  <table class="table">

    <% @plant.tasks.each do |task| %>
      <tr>
        <td>
          <% if task.hide %>
            <div class="task-visibility" data-task-id="<%= task.id %>" data-plant-id="<%= task.plant.id %>" data-path="/plants/">
              <%= image_tag "eye_not_visible.jpg" %>
            </div>
          <% else %>
            <div class="task-visibility" data-task-id="<%= task.id %>" data-plant-id="<%= task.plant.id %>" data-path="/plants/">
            <%= image_tag "eye_visible.jpg" %>
            </div>
          <% end %>
        </td>
        <td class="show-details">
          <a><%= task.title %> <small><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></small></a>
        </td>
        <td>
          <% if user_signed_in? %>
            <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
            <% if task.done? %>
              ist erledigt
            <% elsif task.skipped? %>
              übersprungen
            <% elsif task.upcoming? %>
              <span class="task-warning">wartet auf Ausführung</span>
            <% else %>
              steht zur Zeit nicht an
            <% end %>
          <% end %>
        </td>
        <td>
          <% if can? :manage, @plant %>
            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
              <%= link_to 'Bearbeiten', edit_plant_task_path({ id: task.id, plant_id: task.plant_id }) %>&nbsp;
            <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
            <%= link_to 'Entfernen', [task.plant, task], method: :delete, data: { confirm: 'Sind Sie sicher?' }, class: "delete-link" %>
          <% end %>
        </td>
      </tr>

      <tr class="task-details">
        <td colspan="4">

          <div class="panel panel-default">
            <div class="panel-body">
              <div class="row">
                <div class="col-xs-12">
                  <% if task_time_frame(task).present? %>
                    <strong>Zeitraum:</strong>&nbsp;<%= task_time_frame(task) %>
                    &nbsp;<%= image_tag "green_flower_icon.png", width: "15px" %>&nbsp;
                  <% end %>

                  <strong>Wiederholung:</strong>
                  <%= task.repeat.humanize %>
                </div>
              </div>
              <br>

              <div class="row">
                <div class="col-xs-12">
                  <%= raw markdown.render(task.desc) %>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-12 task-action-links">
                  <% if can? :manage, task %>
                      <% if task.upcoming? %>
                        <%= link_to "überspringen", plant_task_done_tasks_path({task_id: task.id, plant_id: task.plant.id, done_task: { skipped: true } }), method: :post, class: "btn btn-default", role: "button" %>&nbsp;
                      <% end %>
                      <button type="button" class="btn btn-default" data-toggle="modal" data-target="#taskDoneModal<%= task.id %>">
                        erledigt
                      </button>
                  <% end %>
                </div>
                <%= render partial: "done_tasks/modal", locals: { task: task } %>
              </div>

            </div>
          </div>


        </td>
      </tr>
    <% end %>
  </table>

  <div class="row">
    <div class="col-xs-12">
      <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
        <%= link_to "Neue Aufgabe", new_plant_task_path(@plant) %>
    </div>
  </div>

<% end %>
